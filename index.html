<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NIW Evidence Mapping Â· Expanded</title>
  <style>
    :root{
      --bg:#0b1020; --bg2:#0e1630;
      --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.68);
      --accent:#7aa6ff; --gold:#f2c66d; --ok:#7affc3; --danger:#ff7a7a;
      --radius:18px; --radius2:26px; --max:1100px;
      --shadow:0 18px 60px rgba(0,0,0,.40);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Noto Sans KR, Arial;
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(122,166,255,.22), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(242,198,109,.18), transparent 60%),
        radial-gradient(900px 650px at 50% 90%, rgba(122,255,195,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      line-height:1.55;
    }
    .wrap{max-width:var(--max); margin:0 auto; padding:0 20px;}
    .nav{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(14px);
      background: rgba(10,16,32,.55);
      border-bottom: 1px solid var(--border);
    }
    .nav-inner{display:flex; justify-content:space-between; align-items:center; padding:14px 0; gap:12px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800;}
    .logo{width:34px; height:34px; border-radius:10px; background: linear-gradient(135deg, rgba(122,166,255,.95), rgba(242,198,109,.95)); box-shadow:0 10px 25px rgba(0,0,0,.35)}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:10px 14px; border-radius:999px;
      border:1px solid var(--border); background:rgba(255,255,255,.05);
      color:var(--text); text-decoration:none; font-weight:750;
      cursor:pointer; transition:transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.07); border-color:rgba(255,255,255,.20)}
    .btn.primary{border-color:rgba(122,166,255,.55); background: linear-gradient(135deg, rgba(122,166,255,.25), rgba(242,198,109,.15));}
    .btn.ghost{background:transparent}
    .pill{display:inline-flex; gap:8px; padding:7px 11px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--border); color:var(--muted); font-weight:700; font-size:13px}
    .card{border:1px solid var(--border); background:var(--card); border-radius:var(--radius2); box-shadow:var(--shadow);}
    header{padding:28px 0 10px}
    h1{margin:10px 0 8px; font-size: clamp(26px, 3.4vw, 40px); line-height:1.12; letter-spacing:-.6px}
    p.lead{margin:0; color:var(--muted); max-width:75ch}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; align-items:stretch; margin-top:16px;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }
    .panel{padding:22px}
    .steps{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .stepdot{
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--border); background:rgba(255,255,255,.05);
      color:var(--muted); font-weight:750; font-size:12px;
    }
    .stepdot.active{border-color: rgba(122,166,255,.55); color: rgba(255,255,255,.88); background: rgba(122,166,255,.12);}
    .stepdot.done{border-color: rgba(122,255,195,.45); color: rgba(255,255,255,.88); background: rgba(122,255,195,.10);}
    section{padding: 12px 0 28px}
    .box{padding:18px; border-radius: var(--radius); border:1px solid var(--border); background: rgba(0,0,0,.18);}
    .qtitle{margin:0 0 8px; font-size:16px; letter-spacing:-.2px}
    .muted{color:var(--muted)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 720px){ .row{grid-template-columns:1fr;} }
    label{display:block; font-size:12px; font-weight:800; color:rgba(255,255,255,.76); margin:10px 0 6px}
    input[type="text"], input[type="email"], textarea, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    .choice{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--border); background:rgba(255,255,255,.05);
      cursor:pointer; transition:transform .12s ease, background .12s ease;
      margin-top:8px;
    }
    .choice:hover{transform:translateY(-1px); background:rgba(255,255,255,.07)}
    input[type="radio"], input[type="checkbox"]{margin-top:2px; accent-color:var(--accent)}
    .hint{
      margin-top:10px; font-size:13px; color:var(--muted);
      border-left: 3px solid rgba(242,198,109,.45);
      padding-left: 10px;
    }
    .bar{
      height:10px; border-radius:999px; background:rgba(255,255,255,.08);
      overflow:hidden; border:1px solid rgba(255,255,255,.10);
    }
    .bar > div{height:100%; width:0%; background: linear-gradient(90deg, rgba(122,166,255,.9), rgba(242,198,109,.85)); transition: width .18s ease;}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; justify-content:space-between; align-items:center;}
    .actions .left{display:flex; gap:10px; flex-wrap:wrap;}
    .mini{
      padding:14px; border-radius:16px; border:1px solid var(--border); background:rgba(255,255,255,.05);
    }
    .mini strong{display:block; margin-bottom:6px}
    .tag{display:inline-flex; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.05); color:var(--muted); font-weight:750; font-size:12px; margin-right:8px; margin-top:8px}
    .warn{border-color: rgba(255,122,122,.35); background: rgba(255,122,122,.06);}
    .ok{border-color: rgba(122,255,195,.30); background: rgba(122,255,195,.06);}
    .result{
      padding:18px; border-radius: var(--radius2);
      border:1px solid rgba(122,166,255,.35);
      background: linear-gradient(180deg, rgba(122,166,255,.10), rgba(255,255,255,.03));
    }
    .result h3{margin:0 0 10px}
    .copybox{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      padding: 12px;
      color: rgba(255,255,255,.90);
      font-size: 13px;
      white-space: pre-wrap;
    }
    .foot{padding:24px 0 40px; color:rgba(255,255,255,.60); font-size:12px; border-top:1px solid rgba(255,255,255,.10); margin-top:24px;}
    .hidden{display:none}
  </style>
</head>

<body>
  <div class="nav">
    <div class="wrap">
      <div class="nav-inner">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            NIW Evidence Mapping
            <div class="muted" style="font-weight:750; font-size:12px; margin-top:2px;">Expanded Â· Multi-step</div>
          </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <a class="btn ghost" href="#tool">ë„êµ¬</a>
          <button class="btn gold" id="btnReset" type="button">ì´ˆê¸°í™”</button>
          <button class="btn primary" id="btnJumpStart" type="button">ì‹œì‘ / ì´ì–´ì„œ</button>
        </div>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap">
      <div class="card panel">
        <span class="pill">ì¦ê±° ê¸°ë°˜ Â· ì ìˆ˜ëŠ” ìˆ¨ê¹€ Â· ìš”ì•½ ë¦¬í¬íŠ¸ ìë™ ìƒì„±</span>
        <h1>ê³ ê°ì´ â€œì ìˆ˜í‘œâ€ê°€ ì•„ë‹ˆë¼<br/>ì „ë¬¸ê°€ì˜ ì‚¬ê³  êµ¬ì¡°ë¥¼ ì²´í—˜í•˜ê²Œ ë§Œë“œì‹­ì‹œì˜¤.</h1>
        <p class="lead">
          ì´ í™•ì¥íŒì€ <strong>ë©€í‹°ìŠ¤í… ì§ˆë¬¸</strong>ìœ¼ë¡œ ì§„í–‰ë˜ë©°,
          ê° ë‹¨ê³„ëŠ” â€œíŒë‹¨â€ì´ ì•„ë‹ˆë¼ <strong>ì¦ê±° ë§¤í•‘</strong>ì„ ìš”êµ¬í•©ë‹ˆë‹¤.
          ë§ˆì§€ë§‰ì—ëŠ” <strong>ìƒë‹´ìš© ìš”ì•½ ë¦¬í¬íŠ¸</strong>ê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤.
        </p>

        <div style="margin-top:14px">
          <div class="muted" style="font-weight:800; margin-bottom:8px;">ì§„í–‰ë„</div>
          <div class="bar" aria-label="progress bar"><div id="progressFill"></div></div>
          <div class="steps" id="stepDots" aria-label="step dots"></div>
        </div>
      </div>
    </div>
  </header>

  <section id="tool">
    <div class="wrap">
      <div class="grid">
        <!-- LEFT: Wizard -->
        <div class="card panel">
          <div id="wizard"></div>

          <div class="actions">
            <div class="left">
              <button class="btn" id="btnPrev" type="button">â† ì´ì „</button>
              <button class="btn primary" id="btnNext" type="button">ë‹¤ìŒ â†’</button>
            </div>
            <div class="muted" id="saveHint" style="font-size:12px;">
              ì…ë ¥ì€ ë¸Œë¼ìš°ì €ì— ì„ì‹œ ì €ì¥ë©ë‹ˆë‹¤(ë¡œì»¬). ì „ì†¡ì€ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
            </div>
          </div>
        </div>

        <!-- RIGHT: Live guidance -->
        <div class="card panel">
          <div class="mini">
            <strong>ì´ ë„êµ¬ê°€ í•˜ëŠ” ì¼</strong>
            <div class="muted">
              í•©ê²©ì„ ì˜ˆì¸¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹  <strong>í˜„ì¬ ìë£Œê°€ NIW ë…¼ë¦¬ íë¦„ì— ì •ë ¬ë˜ì–´ ìˆëŠ”ì§€</strong>ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
            </div>
          </div>

          <div class="mini" style="margin-top:12px">
            <strong>ì ìˆ˜ ê³µê°œë¥¼ ë¯¸ë£¨ëŠ” ì´ìœ </strong>
            <div class="muted">
              ì ìˆ˜ëŠ” â€œíŒì •â€ì²˜ëŸ¼ ëŠê»´ì ¸ ì‹ ë¢°ë¥¼ í•´ì¹©ë‹ˆë‹¤. ìš°ë¦¬ëŠ” ì ìˆ˜ë³´ë‹¤ <strong>ë³‘ëª©(ë…¼ë¦¬ ëŠê¹€)</strong>ê³¼ <strong>ì¦ê±° ë³´ê°• ë°©í–¥</strong>ì„ ë¨¼ì € ë³´ì—¬ì¤ë‹ˆë‹¤.
            </div>
          </div>

          <div class="mini warn" style="margin-top:12px" id="bottleneckBox">
            <strong>í˜„ì¬ê¹Œì§€ ê°ì§€ëœ ë³‘ëª©</strong>
            <div class="muted" id="bottleneckText" style="margin-top:6px">
              ì•„ì§ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì§ˆë¬¸ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.
            </div>
          </div>

          <div class="mini ok" style="margin-top:12px">
            <strong>ìƒë‹´ íš¨ìœ¨</strong>
            <div class="muted">
              ì™„ë£Œ í›„ ìƒì„±ë˜ëŠ” <strong>ìš”ì•½ ë¦¬í¬íŠ¸</strong>ë¥¼ ê·¸ëŒ€ë¡œ ì´ë©”ì¼/CRMë¡œ ë³´ë‚´ë©´,
              ìƒë‹´ì€ â€œê°€ëŠ¥ì„±â€ì´ ì•„ë‹ˆë¼ â€œêµ¬ì¡° ì„¤ê³„â€ë¶€í„° ë°”ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>
      </div>

      <!-- RESULT -->
      <div class="card panel hidden" id="resultSection" style="margin-top:14px">
        <div class="result">
          <h3>ìš”ì•½ ë¦¬í¬íŠ¸ (ë³µì‚¬í•˜ì—¬ ì „ì†¡ ê°€ëŠ¥)</h3>
          <p class="muted">
            ì´ ê²°ê³¼ëŠ” í•©ê²©/ë¶ˆí•©ê²©ì´ ì•„ë‹™ë‹ˆë‹¤. í˜„ì¬ ìë£Œì˜ ì •ë ¬ ìƒíƒœì™€ ë³‘ëª© ì§€ì ì„ ìš”ì•½í•©ë‹ˆë‹¤.
          </p>

          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="btnCopy" type="button">ğŸ“‹ ë¦¬í¬íŠ¸ ë³µì‚¬</button>
            <button class="btn" id="btnPrint" type="button">ğŸ–¨ï¸ ì¸ì‡„/PDF ì €ì¥</button>
          </div>

          <div class="copybox" id="reportBox" aria-label="report box"></div>

          <div style="margin-top:14px" class="muted">
            * ì‹¤ì œ ìš´ì˜ ì‹œ: Formspree ë˜ëŠ” Cloudflare Worker ì—”ë“œí¬ì¸íŠ¸ë¡œ ì´ ë¦¬í¬íŠ¸ë¥¼ ì „ì†¡í•˜ë„ë¡ ì—°ê²°í•˜ë©´ ë©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="foot">
          <strong>Disclaimer:</strong> ë³¸ ë„êµ¬ëŠ” ì¼ë°˜ ì •ë³´ ì œê³µ ëª©ì ì´ë©° ë²•ë¥  ìë¬¸ì´ ì•„ë‹™ë‹ˆë‹¤. êµ¬ì²´ ì‚¬ì•ˆì€ ìƒë‹´ì„ í†µí•´ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </section>

  <script>
    /**
     * Expanded NIW Evidence Mapping (single-file)
     * - Multi-step wizard
     * - Evidence-linked inputs
     * - Hidden scoring
     * - Bottleneck detection
     * - Summary report generation
     *
     * NOTE: This demo stores in localStorage only.
     * You can connect to Formspree/Worker by POSTing `buildReport()` output.
     */

    const STORAGE_KEY = "niw_evidence_mapping_v1";
    const $ = (sel) => document.querySelector(sel);

    const steps = [
      {
        id: "profile",
        title: "1) ê¸°ë³¸ ì •ë³´",
        subtitle: "ìƒë‹´ ë¦¬í¬íŠ¸ì— í¬í•¨ë  ìµœì†Œ ì •ë³´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.",
        fields: [
          { type:"text", key:"name", label:"ì„±í•¨", placeholder:"ì˜ˆ: í™ê¸¸ë™" },
          { type:"email", key:"email", label:"ì´ë©”ì¼", placeholder:"ì˜ˆ: name@example.com" },
          { type:"text", key:"field", label:"ë¶„ì•¼ / Proposed Endeavor(í•œ ë¬¸ì¥)", placeholder:"ì˜ˆ: AI alignment ê¸°ë°˜ agent architecture ì—°êµ¬" },
        ],
        score: (s) => {
          let pts = 0;
          if (s.name?.trim()) pts++;
          if (s.email?.trim()) pts++;
          if (s.field?.trim()) pts++;
          return {pts, max:3, bottlenecks: pts<2 ? ["ê¸°ë³¸ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤(ì—°ë½/ìš”ì•½ ë¦¬í¬íŠ¸ ìƒì„±ì— í•„ìš”)."] : []};
        }
      },
      {
        id: "endeavor",
        title: "2) Endeavor ì—°ì†ì„±",
        subtitle: "â€˜ê³„íšâ€™ì´ ì•„ë‹Œ, ì´ë¯¸ í•´ì˜¤ë˜ ì „ë¬¸ í™œë™ì˜ ì—°ì¥ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.",
        radios: {
          key: "endeavor_clarity",
          label: "ë‹¹ì‹ ì˜ â€˜ì „ë¬¸ ì¶•â€™ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ë§í•  ìˆ˜ ìˆìŠµë‹ˆê¹Œ?",
          options: [
            { value:"0", text:"ì•„ì§ ì •ë¦¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" },
            { value:"1", text:"ì—¬ëŸ¬ ì¶•ì´ ìˆê³  í•˜ë‚˜ë¡œ ì¢íˆëŠ” ì¤‘ì…ë‹ˆë‹¤" },
            { value:"2", text:"ëª…í™•í•œ í•˜ë‚˜ì˜ ì¶•ì´ ìˆìŠµë‹ˆë‹¤" }
          ]
        },
        evidenceChecks: {
          key: "endeavor_evidence",
          label: "ì—°ì†ì„±ì„ ì¦ëª…í•  ìˆ˜ ìˆëŠ” ìë£Œ(ì œì¶œ ê°€ëŠ¥í•œ í˜•íƒœ)ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”.",
          options: [
            "í”„ë¡œì íŠ¸/ì—°êµ¬ ì‚°ì¶œë¬¼(ë³´ê³ ì„œ/ë…¼ë¬¸/íŠ¹í—ˆ/ì œí’ˆ)",
            "ë°˜ë³µ ìˆ˜í–‰ì„ ë³´ì—¬ì£¼ëŠ” íƒ€ì„ë¼ì¸(ì—°ë„ë³„ í”„ë¡œì íŠ¸/ì—­í• )",
            "ë‚´ ì—­í• ì´ â€˜í•µì‹¬ ì£¼ë„â€™ì˜€ìŒì„ ë³´ì—¬ì£¼ëŠ” ë¬¸ì„œ(ë¦¬ë”/PI/Owner ë“±)",
          ]
        },
        evidenceText: { key:"endeavor_links", label:"ì¦ê±° ë§í¬/ì„¤ëª…(ì„ íƒ)", placeholder:"ì˜ˆ: Google Scholar ë§í¬, í”„ë¡œì íŠ¸ í˜ì´ì§€, ê¹ƒí—ˆë¸Œ, ë³´ê³ ì„œ PDF ë“±" },
        hint: "ì´ ë‹¨ê³„ì—ì„œ â€˜ëª…í™•í•œ ì¶•â€™ + â€˜ë°˜ë³µ ìˆ˜í–‰ ì¦ê±°â€™ê°€ ì—†ìœ¼ë©´, NIW ë…¼ë¦¬ëŠ” ì¶œë°œì ì—ì„œ í”ë“¤ë¦½ë‹ˆë‹¤.",
        score: (s) => {
          const r = parseInt(s.endeavor_clarity ?? "0", 10);
          const checks = (s.endeavor_evidence || []).length;
          let pts = 0;
          pts += r;                 // 0~2
          pts += Math.min(2, checks); // 0~2
          const max = 4;
          const b = [];
          if (r === 0) b.push("Endeavor(ì „ë¬¸ ì¶•)ì´ ì•„ì§ ì •ë¦¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          if (checks < 2) b.push("ì—°ì†ì„±ì„ ë’·ë°›ì¹¨í•˜ëŠ” ì œì¶œ ê°€ëŠ¥í•œ ì¦ê±°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤(ìµœì†Œ 2ê°œ ê¶Œì¥).");
          return {pts, max, bottlenecks: b};
        }
      },
      {
        id: "importance",
        title: "3) National Importance(ë§¥ë½ ì—°ê²°)",
        subtitle: "â€˜ì¤‘ìš”í•˜ë‹¤â€™ëŠ” ì˜ê²¬ì´ ì•„ë‹ˆë¼ ìë£Œë¡œ ì—°ê²°ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.",
        radios: {
          key: "importance_level",
          label: "ë‹¹ì‹ ì˜ í™œë™ì´ ë¯¸ì¹˜ëŠ” ë²”ìœ„ë¥¼ ê°€ì¥ ê°€ê¹ê²Œ ê³ ë¥´ì„¸ìš”.",
          options: [
            { value:"0", text:"ê°œì¸/íŒ€ ìˆ˜ì¤€" },
            { value:"1", text:"íšŒì‚¬/ê¸°ê´€ ìˆ˜ì¤€" },
            { value:"2", text:"ì‚°ì—…/ë¶„ì•¼ ìˆ˜ì¤€" },
            { value:"3", text:"êµ­ê°€/ì •ì±…/ê³µê³µ ìˆ˜ì¤€" }
          ]
        },
        evidenceChecks: {
          key: "importance_evidence",
          label: "ë¯¸êµ­ ë‚´ ì¤‘ìš”ì„±ì„ â€˜ìë£Œâ€™ë¡œ ì„¤ëª…í•  ìˆ˜ ìˆìŠµë‹ˆê¹Œ?",
          options: [
            "ì‹œì¥/ì‚°ì—… ë³´ê³ ì„œ(ë¦¬í¬íŠ¸/í†µê³„)ë¡œ ìˆ˜ìš”ë¥¼ ì„¤ëª… ê°€ëŠ¥",
            "ì—°ë°©/ì£¼ ì •ì±…Â·ê³µê³µ ë¬¸ì„œë¡œ ë§¥ë½ ì—°ê²° ê°€ëŠ¥",
            "ë¯¸êµ­ ë‚´ ì ìš©/ë„ì… ì‚¬ë¡€(ê¸°ê´€Â·í”„ë¡œì íŠ¸)ì™€ ì—°ê²° ê°€ëŠ¥",
          ]
        },
        evidenceText: { key:"importance_links", label:"ìë£Œ ë§í¬/ë©”ëª¨(ì„ íƒ)", placeholder:"ì˜ˆ: DOE/NSF ê´€ë ¨ ë¬¸ì„œ, ì‚°ì—… ë¦¬í¬íŠ¸, ë¯¸êµ­ í”„ë¡œì íŠ¸ ë§í¬ ë“±" },
        hint: "National ImportanceëŠ” â€˜ë‚´ê°€ ì¤‘ìš”í•˜ë‹¤â€™ê°€ ì•„ë‹ˆë¼ â€˜ë¯¸êµ­ì´ ì™œ ì´ê²ƒì„ ì¤‘ìš”í•˜ê²Œ ë³´ëŠ”ê°€â€™ì˜ ì–¸ì–´ë¡œ ì¨ì•¼ í•©ë‹ˆë‹¤.",
        score: (s) => {
          const r = parseInt(s.importance_level ?? "0", 10); // 0~3
          const checks = (s.importance_evidence || []).length; // 0~3
          let pts = 0;
          pts += Math.min(3, r);
          pts += Math.min(3, checks);
          const max = 6;
          const b = [];
          if (r <= 1) b.push("ì˜í–¥ ë²”ìœ„ê°€ â€˜ì‚°ì—…/ì •ì±…â€™ ìˆ˜ì¤€ìœ¼ë¡œ ì •ë¦¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤(ì¤‘ìš”ì„± ë…¼ë¦¬ ì•½í™”).");
          if (checks < 2) b.push("ì¤‘ìš”ì„±ì„ ë’·ë°›ì¹¨í•  ìë£Œ(ì •ì±…/ì‹œì¥/ì‚¬ë¡€)ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          return {pts, max, bottlenecks: b};
        }
      },
      {
        id: "positioned",
        title: "4) Well Positioned(ìˆ˜í–‰ ëŠ¥ë ¥)",
        subtitle: "ì‹¤ì ì˜ â€˜ì–‘â€™ì´ ì•„ë‹ˆë¼, Endeavorì™€ì˜ â€˜ì§ê²°ì„±â€™ê³¼ â€˜í•µì‹¬ ì£¼ë„ì„±â€™ì…ë‹ˆë‹¤.",
        radios: {
          key: "track_record",
          label: "Endeavorì™€ ì§ì ‘ ì—°ê²°ë˜ëŠ” ê³¼ê±° ì‹¤ì (ëŒ€í‘œ ì‚°ì¶œë¬¼)ì´ ìˆìŠµë‹ˆê¹Œ?",
          options: [
            { value:"0", text:"ì—†ê±°ë‚˜ ì—°ê²°ì´ ì•½í•©ë‹ˆë‹¤" },
            { value:"1", text:"ì¼ë¶€ ì—°ê²°ë˜ëŠ” ì‹¤ì ì´ ìˆìŠµë‹ˆë‹¤" },
            { value:"2", text:"ë‹¤ìˆ˜ì˜ ì‹¤ì ì´ ì§ì ‘ ì—°ê²°ë©ë‹ˆë‹¤" },
            { value:"3", text:"í•µì‹¬ ì£¼ë„ ì‹¤ì ì´ ëª…í™•í•©ë‹ˆë‹¤" }
          ]
        },
        evidenceChecks: {
          key: "positioned_evidence",
          label: "ìˆ˜í–‰ ëŠ¥ë ¥ì„ ê°ê´€í™”í•  ì¦ê±°ë¥¼ ì„ íƒí•˜ì„¸ìš”.",
          options: [
            "ë…ë¦½ì  í‰ê°€(ì¸ìš©/ì‹¬ì‚¬/ì´ˆì²­/ì™¸ë¶€ ìˆ˜ìƒ ë“±)",
            "ë¦¬ë”ì‹­ ì¦ë¹™(PI/ë¦¬ë“œ/ì˜¤ë„ˆ/ì´ê´„ ì—­í•  ë¬¸ì„œ)",
            "ì™¸ë¶€ ì¶”ì²œì¸(ì´í•´ê´€ê³„ ì ì€ ë…ë¦½ ì¶”ì²œì¸) í™•ë³´ ê°€ëŠ¥",
          ]
        },
        evidenceText: { key:"positioned_links", label:"ëŒ€í‘œ ì‚°ì¶œë¬¼ ë§í¬/ë©”ëª¨(ì„ íƒ)", placeholder:"ì˜ˆ: ë…¼ë¬¸ ë§í¬, ì œí’ˆ/íŠ¹í—ˆ, í”„ë¡œì íŠ¸ ê²°ê³¼ ë³´ê³ ì„œ ë“±" },
        hint: "ì¶”ì²œì„œë§Œìœ¼ë¡œëŠ” ìƒí•œì´ ìˆìŠµë‹ˆë‹¤. â€˜ë…ë¦½ ìë£Œ + ì‹¤ë¬¼ ì¦ê±°â€™ê°€ ìˆì–´ì•¼ 3ì  ì˜ì—­ìœ¼ë¡œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.",
        score: (s) => {
          const r = parseInt(s.track_record ?? "0", 10); // 0~3
          const checks = (s.positioned_evidence || []).length; // 0~3
          let pts = 0;
          pts += Math.min(3, r);
          pts += Math.min(3, checks);
          const max = 6;
          const b = [];
          if (r <= 1) b.push("Endeavorì™€ ì§ì ‘ ì—°ê²°ë˜ëŠ” í•µì‹¬ ì‹¤ì ì´ ì•½í•©ë‹ˆë‹¤(ì •ë ¬ ì¬êµ¬ì„± í•„ìš”).");
          if (checks < 2) b.push("ìˆ˜í–‰ ëŠ¥ë ¥ì„ ê°ê´€í™”í•  ë…ë¦½ ìë£Œ/ë¦¬ë”ì‹­ ì¦ê±°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          return {pts, max, bottlenecks: b};
        }
      },
      {
        id: "balancing",
        title: "5) Balancing Test(ë©´ì œ ì •ë‹¹ì„±)",
        subtitle: "PERMì´ ì™œ ë¹„íš¨ìœ¨ì ì¸ì§€ â€˜êµ¬ì¡°ì ìœ¼ë¡œâ€™ ì„¤ëª…í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.",
        radios: {
          key: "perm_fit",
          label: "PERM ê³ ìš© ì ˆì°¨ê°€ ë¶€ì ì ˆí•œ ì´ìœ ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆìŠµë‹ˆê¹Œ?",
          options: [
            { value:"0", text:"ì„¤ëª…í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤" },
            { value:"1", text:"ì˜ê²¬ ìˆ˜ì¤€ìœ¼ë¡œëŠ” ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤" },
            { value:"2", text:"ë…¼ë¦¬ì ìœ¼ë¡œ ì„¤ëª… ê°€ëŠ¥í•©ë‹ˆë‹¤" },
            { value:"3", text:"êµ¬ì¡°ì ìœ¼ë¡œ(ì •ì±…/ì‹œì¥/ì§ë¬´ íŠ¹ì„±) ì„¤ëª… ê°€ëŠ¥í•©ë‹ˆë‹¤" }
          ]
        },
        evidenceChecks: {
          key: "balancing_evidence",
          label: "ë©´ì œ ì •ë‹¹ì„±ì„ ë’·ë°›ì¹¨í•  ìë£Œê°€ ìˆìŠµë‹ˆê¹Œ?",
          options: [
            "íŠ¹ìˆ˜ì„±/í¬ì†Œì„±(ëŒ€ì²´ ì–´ë ¤ì›€)ì„ ë³´ì—¬ì£¼ëŠ” ê·¼ê±°",
            "ì¦‰ì‹œì„±(ì§€ê¸ˆ í•„ìš”í•œ ì´ìœ ) ê·¼ê±°: ê³„ì•½/ì´ˆì²­/í˜‘ì—… ë“±",
            "ë¯¸êµ­ ë‚´ íŒŒê¸‰íš¨ê³¼ë¥¼ ì„¤ëª…í•  ìë£Œ(ê³µê³µì„±/í™•ì‚°ì„±)",
          ]
        },
        evidenceText: { key:"balancing_links", label:"ê·¼ê±°/ë©”ëª¨(ì„ íƒ)", placeholder:"ì˜ˆ: LOI, í˜‘ì—… ì´ë©”ì¼, ì—°êµ¬ê³„íšê³¼ ê³¼ê±° ì‹¤ì  ì—°ê²° ìš”ì•½ ë“±" },
        hint: "Balancingì€ ë§ˆì§€ë§‰ì— ë¶™ì´ëŠ” ë¬¸ì¥ì´ ì•„ë‹ˆë¼, ì „ì²´ ë…¼ë¦¬ì˜ â€˜ì •ë‹¹í™”â€™ì…ë‹ˆë‹¤.",
        score: (s) => {
          const r = parseInt(s.perm_fit ?? "0", 10); // 0~3
          const checks = (s.balancing_evidence || []).length; // 0~3
          let pts = 0;
          pts += Math.min(3, r);
          pts += Math.min(3, checks);
          const max = 6;
          const b = [];
          if (r <= 1) b.push("PERM ë©´ì œ ì •ë‹¹ì„± ë…¼ë¦¬ê°€ â€˜ì˜ê²¬â€™ ìˆ˜ì¤€ì— ë¨¸ë¬¼ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤.");
          if (checks < 2) b.push("ë©´ì œ ì •ë‹¹ì„±ì„ ë’·ë°›ì¹¨í•  â€˜ì¦‰ì‹œì„±/í¬ì†Œì„±/íŒŒê¸‰â€™ ìë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          return {pts, max, bottlenecks: b};
        }
      },
      {
        id: "final",
        title: "6) ê²°ê³¼ ìƒì„±",
        subtitle: "ì ìˆ˜ ëŒ€ì‹  â€˜ë³‘ëª©â€™ê³¼ â€˜ë³´ê°• ë°©í–¥â€™ì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.",
        final: true,
        score: (s) => ({pts:0, max:0, bottlenecks:[]})
      }
    ];

    let state = loadState();
    let stepIndex = state._stepIndex ?? 0;

    const stepDots = $("#stepDots");
    const wizard = $("#wizard");
    const progressFill = $("#progressFill");

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return {};
        return JSON.parse(raw);
      }catch(e){
        return {};
      }
    }
    function saveState(){
      state._stepIndex = stepIndex;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function setProgress(){
      const pct = Math.round((stepIndex / (steps.length-1)) * 100);
      progressFill.style.width = pct + "%";
      stepDots.innerHTML = "";
      steps.forEach((st, i) => {
        const d = document.createElement("div");
        d.className = "stepdot";
        d.textContent = st.title;
        if(i === stepIndex) d.classList.add("active");
        if(i < stepIndex) d.classList.add("done");
        d.addEventListener("click", () => {
          stepIndex = i;
          render();
        });
        stepDots.appendChild(d);
      });
    }

    function render(){
      setProgress();
      const st = steps[stepIndex];
      $("#resultSection").classList.add("hidden");

      wizard.innerHTML = `
        <div class="box">
          <div class="muted" style="font-weight:800; letter-spacing:.2px; margin-bottom:6px;">${st.title}</div>
          <div class="qtitle">${st.subtitle || ""}</div>
          ${st.hint ? `<div class="hint">${st.hint}</div>` : ""}
          <div id="content"></div>
        </div>
      `;

      const content = wizard.querySelector("#content");

      // Build content
      if(st.fields){
        const rows = [];
        for(const f of st.fields){
          rows.push(`
            <div>
              <label for="${f.key}">${f.label}</label>
              <input id="${f.key}" type="${f.type}" value="${escapeHtml(state[f.key] || "")}" placeholder="${escapeHtml(f.placeholder || "")}" />
            </div>
          `);
        }
        content.innerHTML = `<div class="row">${rows.join("")}</div>`;
        st.fields.forEach(f => {
          const el = $("#" + f.key);
          el.addEventListener("input", () => {
            state[f.key] = el.value;
            saveState();
            updateBottlenecks();
          });
        });
      }

      if(st.radios){
        const rKey = st.radios.key;
        const cur = state[rKey] ?? "";
        const opts = st.radios.options.map(o => `
          <label class="choice">
            <input type="radio" name="${rKey}" value="${o.value}" ${String(cur)===String(o.value) ? "checked":""} />
            ${escapeHtml(o.text)}
          </label>
        `).join("");
        const block = document.createElement("div");
        block.innerHTML = `
          <label style="margin-top:14px">${escapeHtml(st.radios.label)}</label>
          <div>${opts}</div>
        `;
        content.appendChild(block);

        block.querySelectorAll(`input[name="${rKey}"]`).forEach(inp => {
          inp.addEventListener("change", () => {
            state[rKey] = inp.value;
            saveState();
            updateBottlenecks();
          });
        });
      }

      if(st.evidenceChecks){
        const cKey = st.evidenceChecks.key;
        const curArr = Array.isArray(state[cKey]) ? state[cKey] : [];
        const opts = st.evidenceChecks.options.map((txt, idx) => {
          const checked = curArr.includes(txt);
          return `
            <label class="choice">
              <input type="checkbox" data-ckey="${cKey}" value="${escapeHtml(txt)}" ${checked ? "checked":""} />
              ${escapeHtml(txt)}
            </label>
          `;
        }).join("");
        const block = document.createElement("div");
        block.innerHTML = `
          <label style="margin-top:14px">${escapeHtml(st.evidenceChecks.label)}</label>
          <div>${opts}</div>
        `;
        content.appendChild(block);

        block.querySelectorAll(`input[type="checkbox"][data-ckey="${cKey}"]`).forEach(inp => {
          inp.addEventListener("change", () => {
            const val = inp.value;
            let arr = Array.isArray(state[cKey]) ? state[cKey] : [];
            if(inp.checked){
              if(!arr.includes(val)) arr.push(val);
            }else{
              arr = arr.filter(x => x !== val);
            }
            state[cKey] = arr;
            saveState();
            updateBottlenecks();
          });
        });
      }

      if(st.evidenceText){
        const tKey = st.evidenceText.key;
        const block = document.createElement("div");
        block.innerHTML = `
          <label for="${tKey}" style="margin-top:14px">${escapeHtml(st.evidenceText.label)}</label>
          <textarea id="${tKey}" placeholder="${escapeHtml(st.evidenceText.placeholder || "")}">${escapeHtml(state[tKey] || "")}</textarea>
          <div class="muted" style="font-size:12px; margin-top:8px">
            ì˜ˆ: ë§í¬(êµ¬ê¸€ìŠ¤ì¹¼ë¼/í”„ë¡œì íŠ¸/ê¹ƒí—ˆë¸Œ), ëŒ€í‘œ ì‚°ì¶œë¬¼, ì™¸ë¶€ í‰ê°€, ì •ì±…/ì‹œì¥ ìë£Œ ë“±
          </div>
        `;
        content.appendChild(block);

        const el = block.querySelector("#" + tKey);
        el.addEventListener("input", () => {
          state[tKey] = el.value;
          saveState();
          updateBottlenecks();
        });
      }

      if(st.final){
        content.innerHTML = `
          <div class="mini ok" style="margin-top:14px">
            <strong>ì™„ë£Œ ì¤€ë¹„</strong>
            <div class="muted" style="margin-top:6px">
              ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, ì§€ê¸ˆê¹Œì§€ì˜ ì…ë ¥ì„ ë°”íƒ•ìœ¼ë¡œ <strong>ìš”ì•½ ë¦¬í¬íŠ¸</strong>ê°€ ìƒì„±ë©ë‹ˆë‹¤.
              ë¦¬í¬íŠ¸ëŠ” ìƒë‹´ ìš”ì²­ ì´ë©”ì¼/CRM ì „ì†¡ì— ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
          </div>
          <div class="actions" style="margin-top:14px; justify-content:flex-start;">
            <button class="btn primary" id="btnBuild" type="button">âœ… ìš”ì•½ ë¦¬í¬íŠ¸ ìƒì„±</button>
          </div>
          <div class="mini warn" style="margin-top:12px">
            <strong>ì£¼ì˜</strong>
            <div class="muted" style="margin-top:6px">
              ì´ ë¦¬í¬íŠ¸ëŠ” í•©ê²©/ë¶ˆí•©ê²©ì´ ì•„ë‹™ë‹ˆë‹¤. â€œí˜„ì¬ ìë£Œì˜ ì •ë ¬ ìƒíƒœâ€ì™€ â€œë³‘ëª© ì§€ì â€ë§Œì„ ìš”ì•½í•©ë‹ˆë‹¤.
            </div>
          </div>
        `;
        content.querySelector("#btnBuild").addEventListener("click", () => {
          showResult();
        });
      }

      // buttons
      $("#btnPrev").disabled = (stepIndex === 0);
      $("#btnNext").textContent = (stepIndex === steps.length-1) ? "ì™„ë£Œ" : "ë‹¤ìŒ â†’";

      updateBottlenecks();
      saveState();
    }

    function updateBottlenecks(){
      const all = [];
      let totalPts = 0, totalMax = 0;

      for(const st of steps){
        if(!st.score) continue;
        const {pts, max, bottlenecks} = st.score(state);
        totalPts += (pts || 0);
        totalMax += (max || 0);
        if(bottlenecks && bottlenecks.length){
          // only collect major bottlenecks (keep it concise)
          for(const b of bottlenecks) all.push("â€¢ " + b);
        }
      }

      const top = all.slice(0, 4);
      $("#bottleneckText").textContent = top.length ? top.join("\n") : "í˜„ì¬ê¹Œì§€ í° ë³‘ëª©ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì¶”ê°€ ì…ë ¥ì— ë”°ë¼ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)";

      // store hidden scores
      state._score = { totalPts, totalMax };
      saveState();
    }

    function showResult(){
      updateBottlenecks();
      const report = buildReport();
      $("#reportBox").textContent = report;
      $("#resultSection").classList.remove("hidden");
      $("#resultSection").scrollIntoView({behavior:"smooth", block:"start"});
    }

    function buildReport(){
      const s = state;
      const score = s._score || {totalPts:0,totalMax:0};
      const pct = score.totalMax ? Math.round((score.totalPts/score.totalMax)*100) : 0;

      const bottlenecks = $("#bottleneckText").textContent || "";

      const lines = [];
      lines.push("NIW Evidence Mapping Â· Summary (Not a legal advice / Not a prediction)");
      lines.push("==============================================================");
      lines.push(`Name: ${s.name || "(blank)"}`);
      lines.push(`Email: ${s.email || "(blank)"}`);
      lines.push(`Field / Endeavor (1 sentence): ${s.field || "(blank)"}`);
      lines.push("");
      lines.push("A) Endeavor Continuity");
      lines.push(`- Clarity: ${labelFrom("endeavor_clarity", s.endeavor_clarity)}`);
      lines.push(`- Evidence (selected): ${(s.endeavor_evidence||[]).join(" / ") || "(none)"}`);
      if(s.endeavor_links) lines.push(`- Links/Notes: ${s.endeavor_links}`);
      lines.push("");
      lines.push("B) National Importance Context");
      lines.push(`- Impact level: ${labelFrom("importance_level", s.importance_level)}`);
      lines.push(`- Evidence (selected): ${(s.importance_evidence||[]).join(" / ") || "(none)"}`);
      if(s.importance_links) lines.push(`- Links/Notes: ${s.importance_links}`);
      lines.push("");
      lines.push("C) Well Positioned");
      lines.push(`- Track record: ${labelFrom("track_record", s.track_record)}`);
      lines.push(`- Evidence (selected): ${(s.positioned_evidence||[]).join(" / ") || "(none)"}`);
      if(s.positioned_links) lines.push(`- Links/Notes: ${s.positioned_links}`);
      lines.push("");
      lines.push("D) Balancing Test (PERM waiver justification)");
      lines.push(`- PERM-fit explanation: ${labelFrom("perm_fit", s.perm_fit)}`);
      lines.push(`- Evidence (selected): ${(s.balancing_evidence||[]).join(" / ") || "(none)"}`);
      if(s.balancing_links) lines.push(`- Links/Notes: ${s.balancing_links}`);
      lines.push("");
      lines.push("Detected bottlenecks (auto):");
      lines.push(bottlenecks ? bottlenecks : "(none)");
      lines.push("");
      lines.push("Internal scoring (hidden; readiness approximation):");
      lines.push(`- Readiness index: ${pct}% (computed from evidence-backed inputs; NOT a prediction)`);
      lines.push("");
      lines.push("Next step suggestion:");
      lines.push("- Re-define endeavor as a single continuous professional axis, then map each claim to 1:1 evidence.");
      lines.push("- If you want a lawyer-led structuring review, submit CV / Scholar / project summary / representative outputs.");
      return lines.join("\n");
    }

    function labelFrom(key, val){
      const st = steps.find(x => x.radios && x.radios.key === key);
      if(!st) return val ?? "(blank)";
      const opt = st.radios.options.find(o => String(o.value)===String(val));
      return opt ? opt.text : "(blank)";
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Controls
    $("#btnPrev").addEventListener("click", () => {
      if(stepIndex > 0){ stepIndex--; render(); }
    });
    $("#btnNext").addEventListener("click", () => {
      if(stepIndex < steps.length-1){ stepIndex++; render(); }
    });
    $("#btnJumpStart").addEventListener("click", () => {
      // jump to last unfinished-ish step: keep simple (current)
      render();
      document.querySelector("#tool").scrollIntoView({behavior:"smooth", block:"start"});
    });
    $("#btnReset").addEventListener("click", () => {
      localStorage.removeItem(STORAGE_KEY);
      state = {};
      stepIndex = 0;
      render();
    });

    $("#btnCopy").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText($("#reportBox").textContent || "");
        $("#btnCopy").textContent = "âœ… ë³µì‚¬ ì™„ë£Œ";
        setTimeout(()=>$("#btnCopy").textContent="ğŸ“‹ ë¦¬í¬íŠ¸ ë³µì‚¬", 1300);
      }catch(e){
        alert("ë³µì‚¬ ê¶Œí•œì´ ì—†ì–´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¦¬í¬íŠ¸ë¥¼ ì§ì ‘ ë“œë˜ê·¸í•˜ì—¬ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
      }
    });

    $("#btnPrint").addEventListener("click", () => window.print());

    // init
    render();
  </script>
</body>
</html>
